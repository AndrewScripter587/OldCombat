import {TemplateArgument} from "./TemplateArgument.js"
import {McFile} from "../Compiler.js"
import {Register} from "../../genes/Register.js"

const $global = Register.$global

export const JsTemplateArgument = Register.global("$hxClasses")["mcl.args.JsTemplateArgument"] = 
class JsTemplateArgument extends Register.inherits(() => TemplateArgument, true) {
	new(s, p) {
		super.new(s, p);
		this.expectJsValue = true;
	}
	parseValue(value, pos, ctx) {
		if (value.startsWith("<%")) {
			let end = value.indexOf("%>");
			if (end == -1) {
				return {"success": false};
			};
			let code = value.substring(2, end);
			try {
				let idx = TemplateArgument.jsCacheIdx;
				let alreadyParsed = TemplateArgument.jsCache.inst.has(idx);
				let v;
				if (!alreadyParsed) {
					v = McFile.invokeExpressionInline(code, ctx, pos);
					TemplateArgument.jsCache.inst.set(idx, v);
				} else {
					v = TemplateArgument.jsCache.inst.get(idx);
				};
				return {"success": true, "value": v, "raw": value.substring(0, end + 2)};
			}catch (_g) {
				return {"success": false};
			};
		};
		return {"success": false};
	}
	static register() {
		TemplateArgument.register("js", JsTemplateArgument);
	}
	static get __name__() {
		return "mcl.args.JsTemplateArgument"
	}
	static get __super__() {
		return TemplateArgument
	}
	get __class__() {
		return JsTemplateArgument
	}
}

